: >MARK HERE @ 0 , ; : >RESOLVE DUP HERE @ SWAP - SWAP ! ; : <MARK HERE @ ; : <RESOLVE HERE @  -  , ;
: IF POSTPONE 0BRANCH >MARK ; IMMEDIATE : AHEAD POSTPONE BRANCH >MARK ; IMMEDIATE
: ELSE POSTPONE BRANCH >MARK SWAP >RESOLVE ; IMMEDIATE : THEN >RESOLVE ; IMMEDIATE
: BEGIN <MARK ; IMMEDIATE : UNTIL POSTPONE 0BRANCH <RESOLVE ; IMMEDIATE 
: DO <MARK POSTPONE DUP POSTPONE 0BRANCH >MARK POSTPONE 1- POSTPONE >R ; IMMEDIATE
: LOOP POSTPONE R> POSTPONE BRANCH SWAP <RESOLVE >RESOLVE POSTPONE DROP ; IMMEDIATE
: / /MOD SWAP DROP ; : VARIABLE CREATE 0 , ; : SP 32 EMIT ;
VARIABLE CURPROGRAM VARIABLE OFFSET : START CREATE HERE @ CURPROGRAM ! 0 , HERE @ + HERE ! ; 
16 BASE !
: H. 10 /MOD . . ;
: PREFIX 0A EMIT 64 EMIT 61 EMIT 74 EMIT 20 EMIT 30 EMIT 78 EMIT ;
0A BASE !
: DUMP ' EXECUTE DUP @ SWAP 3 + SWAP 2 /  DO
1 + DUP C@ PREFIX H. 1 + DUP C@ H. LOOP 2DROP ;

: SOP CREATE , DOES> @ 0 0 ;
: AOP CREATE , DOES> @ 1 ;

 0 SOP A     1 SOP B     2 SOP C     3 SOP X     4 SOP Y     5 SOP Z     6 SOP I     7 SOP J
 8 SOP [A]   9 SOP [B]  10 SOP [C]  11 SOP [X]  12 SOP [Y]  13 SOP [Z]  14 SOP [I]  15 SOP [J]
16 AOP [A+] 17 AOP [B+] 18 AOP [C+] 19 AOP [X+] 20 AOP [Y+] 21 AOP [Z+] 22 AOP [I+] 23 AOP [J+]
24 SOP [SP++]           24 SOP [--SP]           25 SOP [SP] 26 AOP [SP+]            27 SOP SP
28 SOP PC   29 SOP EX   30 AOP [OPLIT]          31 AOP OPLIT 
: OC, C, ; : OALIGN ALIGN ;
: HERE@ CURPROGRAM @ DUP @ + 4 + ; : C, HERE@ C! CURPROGRAM @ @ 1 + CURPROGRAM @ ! ; : 2C, DUP 256 / C, C, ;
: ALIGN CURPROGRAM @ @ 2 /MOD DROP 1 = IF 0 C, THEN ;
: WRITE2C DUP ROT DUP ROT 256 / SWAP C! 1 + C! ;
: MKLABEL CREATE -1 , 0 , DOES> DUP @ DUP -1 = IF DROP 4 + 2 SWAP ELSE SWAP DROP 1 SWAP .S THEN 31 -ROT ;
: WRITELABEL SWAP .S 1 = IF .S 2C, DROP .S ELSE HERE@ SWAP .S ! 0 2C, DROP THEN ;
: SETLABEL CURPROGRAM @ @ OFFSET @ + 2 / DUP >R ' 4 + DUP ROT SWAP ! 4 + @ DUP 0<> 
  IF R> WRITE2C ELSE R> DROP  THEN ; IMMEDIATE
: PROCESSOP SWAP DUP 1 = IF DROP 2C, 1 THEN DUP 2 = IF SWAP HERE@ SWAP ! 0 2C, THEN 0 = IF DROP THEN ;

: 1OP CREATE , DOES> @ HERE@ >R >R 0 0 C, C, PROCESSOP 1024 * R> 32 * + R> SWAP .S WRITE2C ;
: 2OP CREATE , DOES> @ HERE@ >R >R 0 0 C, C, PROCESSOP 1024 * >R PROCESSOP 32 * R> + R> + R> SWAP .S WRITE2C ;

 1 2OP SET  2 2OP ADD   3 2OP SUB   4 2OP MUL   5 2OP MLI   6 2OP DIV   7 2OP DVI   8 2OP MOD   9 2OP MDI
10 2OP AND  11 2OP BOR  12 2OP XOR  13 2OP SHR  14 2OP ASR  15 2OP SHL  16 2OP IFB  17 2OP IFC  18 2OP IFE
19 2OP IFN  20 2OP IFG  21 2OP IFA  22 2OP IFL  23 2OP IFU  26 2OP ADX  27 2OP SBX  30 2OP STI  31 2OP STD
 1 1OP JSR   8 1OP INT   9 1OP IAG  10 1OP IAS  11 1OP RFI  12 1OP IAQ  16 1OP HWN  17 1OP HWQ  18 1OP HWI
19 1OP LOG  20 1OP BRK

: PUSHRSP I OPLIT 1 SUB >R >R >R [I] R> R> R> SET ;
: POPRSP [I] SET I OPLIT 1 ADD ;
VARIABLE LAST
: MCREATE CURPROGRAM @ @ OFFSET @ + 2 / LAST @ 2C, 0 2C,
  OALIGN HERE @ COMPILE-WORDLIST @ >LATEST @ , DUP COMPILE-WORDLIST @ >LATEST ! 0 OC,
  PARSE-WORD DUP 2C, DUP OC, DO DUP C@ DUP OC, C, 1+ LOOP ALIGN OALIGN , DUP 2C, LAST ! DOVAR , DROP
  CURPROGRAM @ @ OFFSET @ + 2 / , DOES> @ 2C, ;
: CODEDEF CURPROGRAM @ @ OFFSET @ + 2 / 1 + 2C, ;
: NEXT A [Z] SET Z OPLIT 1 ADD PC [A] SET ;
16 BASE !
4000 START TEST

MKLABEL COLDSTART

SP OPLIT EFFF SET
I OPLIT FFFF SET
Z COLDSTART SET
NEXT



MCREATE DOVAR
CODEDEF
A OPLIT 1 ADD
[--SP] A SET
NEXT

: VARDEF ['] DOVAR 4 + @ 1 + 2C, ;
: VAR MCREATE VARDEF ;

VAR DOCOL
Z PUSHRSP
A OPLIT 1 ADD
Z A SET
NEXT

: WORDDEF ['] DOCOL 4 + @ 1 + 2C, ;

VAR DOCON
A OPLIT 1 ADD
[--SP] [A] SET
NEXT

: CONST MCREATE ['] DOCON 4 + @ 1 + 2C, ;

VAR STATE 0 2C,
VAR S0 0 2C,
VAR BASE 10 2C,
CONST R0 FFFF 2C,
CONST D0 EFFF 2C,
CONST F_HIDDEN 80 2C,
CONST F_IMMEDIATE 20 2C,
CONST F_COMPILE_ONLY 10 2C,

MCREATE !
CODEDEF
A [SP++] SET
[A] [SP++] SET
NEXT

MCREATE @
CODEDEF
A [SP++] SET
[--SP] [A] SET
NEXT

MCREATE LIT
CODEDEF
[--SP] [Z] SET
Z OPLIT 1 ADD
NEXT

MCREATE BRANCH
CODEDEF
Z [Z] SET
NEXT

MCREATE 0BRANCH
CODEDEF
A [SP++] SET
A OPLIT 0 IFE
MKLABEL ZERO
PC ZERO SET
Z OPLIT 1 ADD
NEXT
SETLABEL ZERO
Z [Z] SET
NEXT

MCREATE DUP
CODEDEF
A [SP] SET
[--SP] A SET
NEXT

MCREATE SWAP
CODEDEF
A [SP++] SET
B [SP++] SET
[--SP] A SET
[--SP] B SET
NEXT

MCREATE +
CODEDEF
A [SP++] SET
[SP] A ADD
NEXT

MCREATE -
CODEDEF
A [SP++] SET
[SP] A SUB
NEXT

MCREATE *
CODEDEF
A [SP++] SET
[SP] A MUL
NEXT

MCREATE /
CODEDEF
A [SP++] SET
[SP] A DIV
NEXT

: OMOD MOD ;
MCREATE MOD
CODEDEF
A [SP++] SET
[SP] A OMOD
NEXT

MCREATE >R
CODEDEF
[SP++] PUSHRSP
NEXT

MCREATE R>
CODEDEF
[--SP] POPRSP
NEXT

MCREATE =
CODEDEF
A OPLIT -1 SET
B [SP++] SET
[SP] B IFE
A OPLIT 0 SET
[SP] A SET
NEXT

MCREATE <>
CODEDEF
A OPLIT -1 SET
B [SP++] SET
[SP] B IFN
A OPLIT -1 SET
[SP] A SET
NEXT

MCREATE >
CODEDEF
A OPLIT -1 SET
B [SP++] SET
[SP] B IFG
A OPLIT -1 SET
[SP] A SET
NEXT

MCREATE <
CODEDEF
A OPLIT -1 SET
B [SP++] SET
[SP] B IFL
A OPLIT -1 SET
[SP] A SET
NEXT

: OHWN HWN ;
MCREATE HWN
CODEDEF
A OHWN
[--SP] A SET
NEXT

: OHWQ HWQ ;
MCREATE HWQ
CODEDEF
A [SP++] SET
A OHWQ
[--SP] X SET
[--SP] Y SET
[--SP] C SET
[--SP] A SET
[--SP] B SET
NEXT

MCREATE EXIT
CODEDEF
Z POPRSP
NEXT

VAR EMITPOS 7FFF 2C,
MCREATE EMIT
WORDDEF
EMITPOS @ LIT 1 2C, + DUP EMITPOS ! SWAP LIT F000 2C, + SWAP !
EXIT

VAR #STORE 0 2C,
VAR #TEMP 0 2C, 0 2C, 0 2C, 0 2C, 0 2C, 0 2C, 0 2C, 0 2C,
VAR #LEN 0 2C,

MCREATE <#
WORDDEF
#STORE !
LIT 0 2C,
#LEN !
EXIT

MCREATE #
WORDDEF
BASE @ #STORE @ MOD 
BASE @ #STORE @ / @STORE !
DUP LIT 10 2C, <
MKLABEL HEX
0BRANCH HEX WRITELABEL
LIT 30 2C, + 
MKLABEL STORE
0BRANCH STORE WRITELABEL
SETLABEL HEX
LIT 37 2C, +
SETLABEL STORE
LIT 8 2C, #LEN @ - #TEMP @ + !
#LEN @ LIT 1 2C, + #LEN !
EXIT

MCREATE #>
WORDDEF
#TEMP @ LIT 8 2C, #LEN @ - +
#LEN @
EXIT

MCREATE TYPE
WORDDEF
MKLABEL TYPE-DONE
MKLABEL START
SETLABEL START
DUP 0BRANCH TYPE-DONE WRITELABEL
SWAP DUP @ EMIT LIT 2C, 1 +
SWAP
DUP LIT 1 2C, -
SETLABEL TYPE-DONE
DROP DROP EXIT

MCREATE .
WORDDEF
<# # # # # #> TYPE
EXIT

SETLABEL COLDSTART
MKLABEL EXIT

LIT 12 2C,
<# # # #> DROP DUP @ EMIT LIT 1 2C, + @ EMIT


SETLABEL EXIT
BRANCH EXIT WRITELABEL
BRANCH EXIT WRITELABEL

ALIGN
DUMP TEST
